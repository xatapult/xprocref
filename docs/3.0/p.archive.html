<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:xtlcon="http://www.xtpxlib.nl/ns/container"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1"><link href="../css/bootstrap.min.css" rel="stylesheet"><link href="../css/xprocref.css" rel="stylesheet"><script defer src="../js/bootstrap.bundle.min.js"></script><title>&nbsp;p:archive (3.0)&nbsp;</title><link rel="shortcut icon" href="../images/favicon.ico"></head><body><nav class="navbar navbar-expand-sm bg-secondary navbar-dark "><div class="container-fluid"><a class="navbar-brand" href="../index.html"><img src="../images/logo.png" class="img-fluid" width="18%"></a></div><div class="container-fluid"><ul class="nav justify-content-end nav-pills text-light"><li class="nav-item lead"><a class="nav-link text-light" href="../index.html">home</a></li><li class="nav-item lead"><a class="nav-link text-light" href="../3.0/categories.html">categories</a></li><li class="nav-item dropdown lead"><a class="nav-link dropdown-toggle text-light" data-bs-toggle="dropdown" href="#">info</a><ul class="dropdown-menu"><li class="lead"><a class="dropdown-item" href="../versions.html">versions</a></li><li class="lead"><a class="dropdown-item" href="../error-codes.html">error codes</a></li><li class="lead"><a class="dropdown-item" href="../namespaces.html">namespaces</a></li><li class="lead"><a class="dropdown-item" href="https://xproc.org">XProc</a></li></ul></li><li class="nav-item lead"><a class="nav-link text-light" href="../about.html">about</a></li></ul></div></nav><div class="container pt-5"><p class="para page-banner">This site is work in progress and therefore incomplete yet.</p><div class="sect1" id="sect1-d354e3503"><a name="sect1-d354e3503"><!----></a><h1 class="sect1"><a href="p.add-xml-base.html"><span class="link"><img src="../images/previous.png" class="inlinemediaobject next-prev-marker" width="1.5%"></span></a>&nbsp;p:archive (3.0)&nbsp;<a href="p.archive-manifest.html"><span class="link"><img src="../images/next.png" class="inlinemediaobject next-prev-marker" width="1.5%"></span></a></h1><p class="para">Perform operations on archive files.</p><ul class="itemizedlist toc toc-2"><li><p class="para tocentry tocentry-2"><a href="#sect2-d354e3516"><span class="link">Summary</span></a></p></li><li><p class="para tocentry tocentry-2"><a href="#sect2-d354e3789"><span class="link">Description</span></a></p><ul class="itemizedlist toc toc-3"><li><p class="para tocentry tocentry-3"><a href="#archive-manifest-format"><span class="link">The XML archive manifest document format</span></a></p></li><li><p class="para tocentry tocentry-3"><a href="#archive-algorithm"><span class="link">The p:archive algorithm</span></a></p></li><li><p class="para tocentry tocentry-3"><a href="#archive-zips"><span class="link">Handling of ZIP archives</span></a></p></li></ul></li><li><p class="para tocentry tocentry-2"><a href="#sect2-d354e4596"><span class="link">Examples</span></a></p><ul class="itemizedlist toc toc-3"><li><p class="para tocentry tocentry-3"><a href="#p_archive-v30-basic-example"><span class="link">Basic usage</span></a></p></li><li><p class="para tocentry tocentry-3"><a href="#sect3-d354e4673"><span class="link">Using the report port</span></a></p></li><li><p class="para tocentry tocentry-3"><a href="#sect3-d354e4690"><span class="link">Using a manifest</span></a></p></li></ul></li><li><p class="para tocentry tocentry-2"><a href="#sect2-d354e4707"><span class="link">Additional details</span></a></p></li><li><p class="para tocentry tocentry-2"><a href="#sect2-d354e4759"><span class="link">Errors raised</span></a></p></li><li><p class="para tocentry tocentry-2"><a href="#sect2-d354e4900"><span class="link">Reference information</span></a></p></li></ul><div class="sect2" id="sect2-d354e3516"><a name="sect2-d354e3516"><!----></a><h2 class="sect2">Summary</h2><div class="programlisting step-signature"><pre class="programlisting step-signature">&lt;p:declare-step type="p:archive"&gt;
  &lt;input port="source" primary="true" content-types="any" sequence="true"/&gt;
  &lt;output port="result" primary="true" content-types="any" sequence="false"/&gt;
  &lt;input port="archive" primary="false" content-types="any" empty="true" sequence="true"&gt;
    &lt;p:empty/&gt;
  &lt;input/&gt;
  &lt;input port="manifest" primary="false" content-types="xml" empty="true" sequence="true"&gt;
    &lt;p:empty/&gt;
  &lt;input/&gt;
  &lt;output port="report" primary="false" content-types="application/xml" sequence="false"/&gt;
  &lt;option name="format" as="xs:QName" required="false" select="'zip'"/&gt;
  &lt;option name="parameters" as="map(xs:QName, item()*)?" required="false" select="()"/&gt;
  &lt;option name="relative-to" as="xs:anyURI?" required="false" select="()"/&gt;
&lt;/p:declare-step&gt;</pre></div><p class="para">The <code class="code step">p:archive</code> step can perform several different operations on archive files (for instance ZIP files). The most common one will likely be
      creating one, but it could also provide services like update, freshen or even merge. The resulting archive appears on its <code class="code port">result</code>
      port.</p><p class="para table-header">Ports:</p><div class="table nonumber ports-table"><table class="table nonumber ports-table"><thead><tr><th><p class="para">Type</p></th><th><p class="para">Port</p></th><th><p class="para">Primary?</p></th><th><p class="para">Content types</p></th><th><p class="para">Seq?</p></th><th><p class="para">Description</p></th></tr></thead><tbody><tr><td><p class="para"><code class="code">input</code></p></td><td><p class="para"><code class="code">source</code></p></td><td><p class="para"><code class="code">true</code></p></td><td><p class="para"><code class="code">any</code></p></td><td><p class="para"><code class="code">true</code></p></td><td><p class="para">The <code class="code port">source</code> port is used to provide the documents to be archived. How and which of these documents are processed is governed
          by the document(s) appearing on the other input ports and the combination of options and parameters. See below for details.</p></td></tr><tr><td><p class="para"><code class="code">output</code></p></td><td><p class="para"><code class="code">result</code></p></td><td><p class="para"><code class="code">true</code></p></td><td><p class="para"><code class="code">any</code></p></td><td><p class="para"><code class="code">false</code></p></td><td><p class="para">The resulting archive.</p></td></tr><tr><td><p class="para"><code class="code">input</code></p></td><td><p class="para"><code class="code">archive</code></p></td><td><p class="para"><code class="code">false</code></p></td><td><p class="para"><code class="code">any</code></p></td><td><p class="para"><code class="code">true</code></p></td><td><p class="para">Optional archives for operations like update, freshen or merge.</p></td></tr><tr><td><p class="para"><code class="code">input</code></p></td><td><p class="para"><code class="code">manifest</code></p></td><td><p class="para"><code class="code">false</code></p></td><td><p class="para"><code class="code">xml</code></p></td><td><p class="para"><code class="code">true</code></p></td><td><p class="para">An optional manifest document that tells the step how to construct the archive. If no manifest document is provided on this port, a
          default manifest is constructed automatically. See <a href="#archive-manifest-format" class="xref">The XML archive manifest document format</a> for details.</p></td></tr><tr><td><p class="para"><code class="code">output</code></p></td><td><p class="para"><code class="code">report</code></p></td><td><p class="para"><code class="code">false</code></p></td><td><p class="para"><code class="code">application/xml</code></p></td><td><p class="para"><code class="code">false</code></p></td><td><p class="para">A report about the archiving operation. This will be the same as the manifest, optionally amended with additional attributes and/or
          elements.</p></td></tr></tbody></table></div><p class="para table-header">Options:</p><div class="table nonumber options-table"><table class="table nonumber options-table"><thead><tr><th><p class="para">Name</p></th><th><p class="para">Type</p></th><th><p class="para">Req?</p></th><th><p class="para">Default</p></th><th><p class="para">Description</p></th></tr></thead><tbody><tr><td><p class="para"><code class="code">format</code></p></td><td><p class="para"><code class="code">xs:QName</code></p></td><td><p class="para"><code class="code">false</code></p></td><td><p class="para"><code class="code">zip</code></p></td><td><p class="para">The format of the archive. </p><ul class="itemizedlist"><li><p class="para">If its value is <code class="code">zip</code> (the default), the <code class="code step">p:archive</code> step expects a ZIP archive on the <code class="code port">source</code> port.</p></li><li><p class="para">Whether any other archive formats can be handled and what their names (values for this option) are is implementation-defined and
              therefore dependent on the XProc processor used.</p></li></ul></td></tr><tr><td><p class="para"><code class="code">parameters</code></p></td><td><p class="para"><code class="code">map(xs:QName, item()*)?</code></p></td><td><p class="para"><code class="code">false</code></p></td><td><p class="para"><code class="code">()</code></p></td><td><p class="para">Parameters controlling the archiving. Several parameters are defined for processing ZIP archives (see <a href="#archive-zips" class="xref">Handling of ZIP archives</a>). A
          specific XProc processor might define its own.</p></td></tr><tr><td><p class="para"><code class="code">relative-to</code></p></td><td><p class="para"><code class="code">xs:anyURI?</code></p></td><td><p class="para"><code class="code">false</code></p></td><td><p class="para"><code class="code">()</code></p></td><td><p class="para">This is option is used in creating a manifest when no manifest is provided on the <code class="code port">manifest</code> port. If a manifest is present
          this option is not used.</p></td></tr></tbody></table></div></div><div class="sect2" id="sect2-d354e3789"><a name="sect2-d354e3789"><!----></a><h2 class="sect2">Description</h2><p class="para">The <code class="code step">p:archive</code> step is the Swiss army knife for handling archives. Its most common use is creating archives, but it could also be used for
      operations like update, freshen or even merge.</p><p class="para">To make all this possible, the operation of <code class="code step">p:archive</code> is unfortunately quite complicated. The details are below, here’s a
      summary:</p><ul class="itemizedlist"><li><p class="para">What’s exactly in the resulting archive is controlled using a manifest document (see <a href="#archive-manifest-format" class="xref">The XML archive manifest document format</a>).
          In such a manifest you specify the URI of the document to add and the path of this document <span class="emphasis italic">in</span> the archive.</p><p class="para">A manifest of an existing archive, sometimes useful as a starting point, can be produced using the <code class="code step"><a href="p.archive-manifest.html"><span class="link">p:archive-manifest</span></a></code>
          step.</p></li><li><p class="para">Besides the documents in the manifest you can also specify documents to add by providing these on the step’s <code class="code port">source</code>
          port. Any document appearing on this port that is not already mentioned in the manifest is automatically added to the manifest. The path of
          such a document <span class="emphasis italic">in</span> the resulting archive can be controlled using the <code class="code option">relative-to</code> option.</p></li><li><p class="para">When adding documents to the archive, <code class="code step">p:archive</code> compares the base URIs in the manifest with those of the documents appearing on the
            <code class="code port">source</code> port (the value of the <code class="code property">base-uri</code> document-property). If these match, the document on the
            <code class="code port">source</code> port is added. If not, the URI in the manifest is used to load a document (usually from disk).</p></li></ul><p class="para">Archives come in many formats. The only format the <code class="code step">p:archive</code> step is required to handle is ZIP. However, depending on the XProc processor used,
    other formats may also be processed.</p><div class="sect3" id="archive-manifest-format"><a name="archive-manifest-format"><!----></a><h3 class="sect3">The XML archive manifest document format</h3><p class="para">An archive manifest is an XML document that specifies files to process constructing the archive. It is also used as the result format of
        the <code class="code step"><a href="p.archive-manifest.html"><span class="link">p:archive-manifest</span></a></code> step.</p><p class="para">Its root element is <code class="tag">&lt;c:archive&gt;</code> (the <code class="code">c</code> prefix here is bound to the <code class="code">http://www.w3.org/ns/xproc-step</code>
        namespace):</p><div class="programlisting" id="c_archive-xlisting"><a name="c_archive-xlisting"><!----></a><pre class="programlisting">&lt;c:archive&gt;
  ( &lt;c:entry&gt; |
    (any other element)
  )*
&lt;/c:archive&gt;</pre></div><p class="para halfbreak" style="font-size: 50%;">&nbsp;</p><div class="table nonumber" id="c_archive-child-elements"><a name="c_archive-child-elements"><!----></a><table class="table nonumber"><thead><tr><th><p class="para">Child element</p></th><th><p class="para">#</p></th><th><p class="para">Description</p></th></tr></thead><tbody><tr><td><p class="para"><code class="code code-width-limited">c:entry</code></p></td><td><p class="para">*</p></td><td><p class="para">An entry (a file) in the archive.</p></td></tr></tbody></table></div><p class="para">A <code class="tag">&lt;c:entry&gt;</code> element describes a single entry (a file) in the archive:</p><div class="programlisting" id="c_entry-xlisting"><a name="c_entry-xlisting"><!----></a><pre class="programlisting">&lt;c:entry name = xs:string
         href = xs:anyURI
         content-type? = xs:string
         comment? = xs:string
         method? = xs:string
         level? = xs:string
         (any other attribute) &gt;
  (any child element)*
&lt;/c:entry&gt;</pre></div><p class="para halfbreak" style="font-size: 50%;">&nbsp;</p><div class="table nonumber" id="c_entry-attributes"><a name="c_entry-attributes"><!----></a><table class="table nonumber"><thead><tr><th><p class="para">Attribute</p></th><th><p class="para">#</p></th><th><p class="para">Type</p></th><th><p class="para">Description</p></th></tr></thead><tbody><tr><td><p class="para"><code class="code code-width-limited">name</code></p></td><td><p class="para">1</p></td><td><p class="para"><code class="code code-width-limited">xs:string</code></p></td><td><p class="para">The name of the entry. This is the path of the file <span class="emphasis italic">within</span> the archive.</p><p class="para">Usually this is a relative path. However, depending on how archives are constructed, an absolute path (a path starting with a
          <code class="code">/</code>) is possible. Archives constructed by XProc steps always produce relative paths (no leading <code class="code">/</code>).</p></td></tr><tr><td><p class="para"><code class="code code-width-limited">href</code></p></td><td><p class="para">1</p></td><td><p class="para"><code class="code code-width-limited">xs:anyURI</code></p></td><td><p class="para">The URI of the entry. This plays an important role in determining which and how files are added to the archive, see below.</p><p class="para">A relative value is made absolute against the base URI of the manifest itself.</p></td></tr><tr><td><p class="para"><code class="code code-width-limited">content-type</code></p></td><td><p class="para">?</p></td><td><p class="para"><code class="code code-width-limited">xs:string</code></p></td><td><p class="para">The content-type (MIME type) of the entry. The <code class="code step">p:archive</code> step ignores it, but the <code class="code step">p:archive-manifest</code>
        step always adds it. </p></td></tr><tr><td><p class="para"><code class="code code-width-limited">comment</code></p></td><td><p class="para">?</p></td><td><p class="para"><code class="code code-width-limited">xs:string</code></p></td><td><p class="para">An optional comment associated with the entry.</p></td></tr><tr><td><p class="para"><code class="code code-width-limited">method</code></p></td><td><p class="para">?</p></td><td><p class="para"><code class="code code-width-limited">xs:string</code></p></td><td><p class="para">The compression method of the entry. There is only one defined value: <code class="code">none</code>, meaning, of course, no compression. Any other
        values are XProc processor dependent.</p></td></tr><tr><td><p class="para"><code class="code code-width-limited">level</code></p></td><td><p class="para">?</p></td><td><p class="para"><code class="code code-width-limited">xs:string</code></p></td><td><p class="para">The compression level of the entry. There are no defined values, all values are XProc processor dependent.</p></td></tr></tbody></table></div></div><div class="sect3" id="archive-algorithm"><a name="archive-algorithm"><!----></a><h3 class="sect3">The <code class="code step">p:archive</code> algorithm</h3><p class="para">The <code class="code step">p:archive</code> step follows a, rather complicated, algorithm. It has two phases:</p><p class="bridgehead">1 - Construct a complete manifest</p><p class="para">First, the manifest (the document, if any, appearing on the <code class="code port">manifest</code> port) is checked and completed if necessary:</p><ul class="itemizedlist"><li><p class="para">If no document appears on the <code class="code port">manifest</code> port, an empty manifest is created.</p></li><li><p class="para">The base URIs of the documents appearing on the <code class="code port">source</code> port are compared against the list of base URIs in the manifest
            (the <code class="code">c:entry/@href</code> values, made absolute). If there are documents on the source port that are <span class="emphasis italic">not</span> in the
            manifest, an entry (<code class="tag">&lt;c:entry&gt;</code> element) for this document is created:</p><ul class="itemizedlist"><li><p class="para">The <code class="code">c:entry/@href</code> attribute becomes the base URI of the document.</p></li><li><p class="para">The <code class="code">c:entry/@name</code> (which is the path/name of the entry in the archive) is computed against the value of the
                  <code class="code option">relative-to</code> option:</p><ul class="itemizedlist"><li><p class="para">If the base URI of the document starts with the value of the <code class="code option">relative-to</code> option, the
                      <code class="code">c:entry/@name</code> attribute value becomes the substring after this.</p></li><li><p class="para">If the base URI of the document does not start with the value of the <code class="code option">relative-to</code> option, the
                      <code class="code">c:entry/@name</code> attribute value becomes the path of this base URI (without a leading <code class="code">/</code>).</p></li></ul><p class="para">For instance, assume the <code class="code option">relative-to</code> option is set to <code class="code">file:///some/path/</code>. A document with base URI
                  <code class="code">file:///some/path/etc/x.txt</code> gets a <code class="code">c:entry/@name</code> attribute value <code class="code">etc/x.txt</code>. A document with
                base URI <code class="code">file:///someother/path/y.txt</code> gets a <code class="code">c:entry/@name</code> attribute value
                <code class="code">someother/path/y.txt</code>.</p></li></ul></li></ul><p class="para">The result of all this is that we now have a manifest that has entries (<code class="tag">&lt;c:entry&gt;</code> elements) for all documents appearing on the
          <code class="code port">source</code> port. It can also have entries for documents that are <span class="emphasis italic">not</span> on the source port: because such an entry
        was present in the initial manifest and no matching document on the <code class="code port">source</code> port was found for it.</p><p class="bridgehead">2 - Process the manifest</p><p class="para">The now completed manifest is processed. For every entry (<code class="tag">&lt;c:entry&gt;</code> element):</p><ul class="itemizedlist"><li><p class="para">If the value of the <code class="code">c:entry/@href</code> attribute matches the base URI of one of the documents appearing on the
              <code class="code port">source</code> port, this document is added to the archive. </p><p class="para">When appropriate (for instance for XML documents), the value of its (optional) <code class="code property">serialization</code> document-property is
            used for serializing it (convert it to text format).</p></li><li><p class="para">For other entries, the value of the <code class="code">c:entry/@href</code> attribute is used to load the file (for instance from disk if it starts
            with <code class="code">file:/</code>) and add it to the archive.</p><p class="para">These documents are used “as is”: no parsing/serialization takes place.</p></li></ul><p class="para">In both cases, the value of the <code class="code">c:entry/@name</code> attribute becomes the name/path of the entry in the archive. The values of the
        other attributes of the <code class="tag">&lt;c:entry&gt;</code> element might also get used, but this is dependent on the XProc processor used and/or the
        archive’s format.</p><p class="para">The <code class="code step">p:archive</code> step is supposed to retain the order of the <code class="tag">&lt;c:entry&gt;</code> elements. This is, for instance, important when constructing an
        e-book in EPUB format: this has a non-compressed entry that must be first in the archive.</p></div><div class="sect3" id="archive-zips"><a name="archive-zips"><!----></a><h3 class="sect3">Handling of ZIP archives</h3><p class="para">When the value of the <code class="code option">format</code> option is absent or <code class="code">zip</code>, the following applies:</p><ul class="itemizedlist"><li><p class="para">The values of the <code class="code">c:entry/@name</code> attributes in the manifest must be relative paths (without a leading
            <code class="code">/</code>).</p></li><li><p class="para">The <code class="code port">archive</code> port accepts zero or one ZIP archive. If this port is empty, an empty ZIP archive is used as its default
            value.</p></li><li><p class="para">The <code class="code option">parameters</code> option is a map that associates parameters (the keys in the map) with values. For ZIP archives, the
            following parameters can be used:</p><div class="table nonumber"><table class="table nonumber"><thead><tr><th><p class="para">Parameter</p></th><th><p class="para">Description</p></th></tr></thead><tbody><tr><td><p class="para"><code class="code">command</code></p></td><td><p class="para">Specifies the operation to perform. It’s default value is <code class="code">update</code>. See below for a description of the
                      commands.</p></td></tr><tr><td><p class="para"><code class="code">level</code></p></td><td><p class="para">For entries that have no <code class="code">c:entry/@level</code> attribute specified, this is the default compression level for entries
                      added or updated in the archive. For ZIP archives, its possible values are:</p><ul class="itemizedlist"><li><p class="para"><code class="code">smallest</code></p></li><li><p class="para"><code class="code">fastest</code></p></li><li><p class="para"><code class="code">default</code></p></li><li><p class="para"><code class="code">huffman</code></p></li><li><p class="para"><code class="code">none</code></p></li></ul><p class="para"></p></td></tr><tr><td><p class="para"><code class="code">method</code></p></td><td><p class="para">For entries that have no <code class="code">c:entry/@method</code> attribute specified, this is the default compression method for
                      entries added or updated in the archive. For ZIP archives, its possible values are:</p><ul class="itemizedlist"><li><p class="para"><code class="code">deflated</code></p></li><li><p class="para"><code class="code">none</code></p></li></ul></td></tr></tbody></table></div><p class="para">The <code class="code">command</code> parameter can have one of the following values:</p><div class="table nonumber"><table class="table nonumber"><thead><tr><th><p class="para">Command</p></th><th><p class="para">Description</p></th></tr></thead><tbody><tr><td><p class="para"><code class="code">update</code> (default)</p></td><td><p class="para">The archive appearing on the <code class="code port">archive</code> port is updated:</p><ul class="itemizedlist"><li><p class="para">An entry in this ZIP archive that corresponds with a <code class="code">c:entry/@name</code> attribute in the manifest gets updated
                          as specified in the <code class="tag">&lt;c:entry&gt;</code> element.</p></li><li><p class="para">For other entries in the ZIP archive, first their name/path is made absolute using the base URI of the archive. If a
                          file exists with that URI and is newer than the entry in the ZIP archive, it is updated.</p></li><li><p class="para">For all <code class="tag">&lt;c:entry&gt;</code> elements in the manifest that have no corresponding entry in the ZIP archive, the document
                          gets added.</p></li></ul><p class="para">Please note that when there is no document on the <code class="code port">archive</code> port, <code class="code step">p:archive</code> will always create a new, fresh,
                      archive.</p></td></tr><tr><td><p class="para"><code class="code">create</code></p></td><td><p class="para">This behaves like the <code class="code">update</code> command except that timestamps are ignored and updates (if any) always take
                      place.</p></td></tr><tr><td><p class="para"><code class="code">freshen</code></p></td><td><p class="para">This behaves like the <code class="code">update</code> command except that no new files will be added.</p></td></tr><tr><td><p class="para"><code class="code">delete</code></p></td><td><p class="para">For the <code class="code">delete</code> command a ZIP archive <code class="code">must</code> be present on the <code class="code port">archive</code> port. It removes
                      all entries in the ZIP archive that have a corresponding <code class="code">c:entry/@name</code> attribute in the manifest. All other
                      manifest entries are ignored.</p></td></tr></tbody></table></div></li></ul></div></div><div class="sect2" id="sect2-d354e4596"><a name="sect2-d354e4596"><!----></a><h2 class="sect2">Examples</h2><div class="sect3" id="p_archive-v30-basic-example"><a name="p_archive-v30-basic-example"><!----></a><h3 class="sect3">Basic usage</h3><p class="para">In probably most cases, the <code class="code step">p:archive</code> step will be used to create an archive. If you have no special requirements this is easy: simply supply
      the documents for the archive on the step’s <code class="code port">source</code> port. The only thing you need to take into account is the name/path of
      the entries in the archive: for this the <code class="code option">relative-to</code> option is important.</p><p class="para keep-with-next">Pipeline document:</p><div class="programlisting"><pre class="programlisting">&lt;p:declare-step xmlns:p="http://www.w3.org/ns/xproc" version="3.0"&gt;

  &lt;p:input port="source" sequence="true"&gt;
    &lt;p:document href="in1.xml"/&gt;
    &lt;p:document href="test/in2.xml"/&gt;
  &lt;/p:input&gt;
  &lt;p:output port="result"/&gt;

  &lt;p:variable name="relative-to" select="resolve-uri('.', static-base-uri())"/&gt;

  &lt;p:archive relative-to="{$relative-to}"/&gt;

  &lt;p:store href="tmp/result.zip"/&gt;
  &lt;p:archive-manifest relative-to="{$relative-to}"/&gt;

&lt;/p:declare-step&gt;</pre></div><p class="para keep-with-next">Result document:</p><div class="programlisting"><pre class="programlisting">&lt;c:archive xmlns:c="http://www.w3.org/ns/xproc-step"&gt;
   &lt;c:entry name="in1.xml"
            content-type="application/xml"
            href="file:/…/…/in1.xml"
            method="deflated"
            size="92"
            compressed-size="81"
            time="2024-10-02T14:51:26+02:00"/&gt;
   &lt;c:entry name="test/in2.xml"
            content-type="application/xml"
            href="file:/…/…/test/in2.xml"
            method="deflated"
            size="99"
            compressed-size="85"
            time="2024-10-02T14:51:26+02:00"/&gt;
&lt;/c:archive&gt;</pre></div><ul class="itemizedlist"><li><p class="para">The pipeline’s input consists of two documents, <code class="code">in1.xml</code> and <code class="code">test/in2.xml</code>. Note that (because the
            <code class="code">p:document/@href</code> attributes have relative values) the paths to these documents are relative to the location of the pipeline
          itself.</p></li><li><p class="para">When we construct an archive we usually don’t want the full path of the files on disk in the archive also. In this case we choose
          to use their relative paths against the pipeline. To achieve this we need the path (directory) where the pipeline is stored. This is done
          with the expression <code class="code">resolve-uri('.', static-base-uri())</code> and stored in the <code class="code">relative-to</code> variable.</p></li><li><p class="para">We then create the archive using <code class="code step">p:archive</code>. The two input documents appear on its <code class="code port">source</code> port. We do not provide a manifest
          on the <code class="code port">manifest</code> port, so one will get constructed automatically.</p></li><li><p class="para">The names of the entries in the resulting archive get constructed by “subtracting” the value of the
            <code class="code option">relative-to</code> option from the base URIs of the source documents. The results will be their relative names against the
          pipeline’s location.</p></li><li><p class="para">We store the resulting zip and, just to show you what’s inside, ask for an archive manifest using the <code class="code step"><a href="p.archive-manifest.html"><span class="link">p:archive-manifest</span></a></code> step.</p></li></ul></div><div class="sect3" id="sect3-d354e4673"><a name="sect3-d354e4673"><!----></a><h3 class="sect3">Using the report port</h3><p class="para">The <code class="code step">p:archive</code> step also has a <code class="code port">report</code> port that outputs the manifest of the resulting archive. So, building on the <a href="#p_archive-v30-basic-example"><span class="link">Basic usage</span></a> example, we could also have shown what’s inside the created archive like this:</p><p class="para keep-with-next">Pipeline document:</p><div class="programlisting"><pre class="programlisting">&lt;p:declare-step xmlns:p="http://www.w3.org/ns/xproc" version="3.0"&gt;

  &lt;p:input port="source" sequence="true"&gt;
    &lt;p:document href="in1.xml"/&gt;
    &lt;p:document href="test/in2.xml"/&gt;
  &lt;/p:input&gt;
  &lt;p:output port="result" pipe="report@create-archive"/&gt;

  &lt;p:variable name="relative-to" select="resolve-uri('.', static-base-uri())"/&gt;

  &lt;p:archive relative-to="{$relative-to}" name="create-archive"/&gt;

  &lt;p:store href="tmp/result.zip"/&gt;

&lt;/p:declare-step&gt;</pre></div><p class="para keep-with-next">Result document:</p><div class="programlisting"><pre class="programlisting">&lt;c:archive xmlns:c="http://www.w3.org/ns/xproc-step"&gt;
   &lt;c:entry href="file:/…/…/in1.xml" name="in1.xml"/&gt;
   &lt;c:entry href="file:/…/…/test/in2.xml" name="test/in2.xml"/&gt;
&lt;/c:archive&gt;</pre></div><p class="para">Note that the information in the manifest is less than what <code class="code step"><a href="p.archive-manifest.html"><span class="link">p:archive-manifest</span></a></code> produces. What exactly happens here is
      implementation-defined and therefore dependent on the XProc processor used.</p></div><div class="sect3" id="sect3-d354e4690"><a name="sect3-d354e4690"><!----></a><h3 class="sect3">Using a manifest</h3><p class="para">This example creates a manifest that references some additional file for the archive. Note that in the archive we give it a different name
      than its source using the <code class="code">c:entry/@name</code> attribute. When the manifest is processed, <code class="code step">p:archive</code> notices that <code class="code">test/in2.xml</code>
      is not on its <code class="code port">source</code> port and therefore loads it from disk.</p><p class="para keep-with-next">Pipeline document:</p><div class="programlisting"><pre class="programlisting">&lt;p:declare-step xmlns:p="http://www.w3.org/ns/xproc" version="3.0" name="example"&gt;

  &lt;p:input port="source" href="in1.xml"/&gt;
  &lt;p:output port="result"/&gt;

  &lt;p:identity name="manifest"&gt;
    &lt;p:with-input&gt;
      &lt;c:archive xmlns:c="http://www.w3.org/ns/xproc-step"&gt;
        &lt;c:entry name="test/extra.xml" href="test/in2.xml"/&gt;
      &lt;/c:archive&gt;
    &lt;/p:with-input&gt;
  &lt;/p:identity&gt;

  &lt;p:variable name="relative-to" select="resolve-uri('.', static-base-uri())"/&gt;
  &lt;p:archive relative-to="{$relative-to}"&gt;
    &lt;p:with-input pipe="source@example"/&gt;
    &lt;p:with-input port="manifest" pipe="result@manifest"/&gt;
  &lt;/p:archive&gt;

  &lt;p:store href="tmp/result.zip"/&gt;
  &lt;p:archive-manifest relative-to="{$relative-to}"/&gt;

&lt;/p:declare-step&gt;</pre></div><p class="para keep-with-next">Result document:</p><div class="programlisting"><pre class="programlisting">&lt;c:archive xmlns:c="http://www.w3.org/ns/xproc-step"&gt;
   &lt;c:entry name="test/extra.xml"
            content-type="application/xml"
            href="file:/…/…/test/extra.xml"
            method="deflated"
            size="60"
            compressed-size="47"
            time="2024-09-03T10:36:32+02:00"/&gt;
   &lt;c:entry name="in1.xml"
            content-type="application/xml"
            href="file:/…/…/in1.xml"
            method="deflated"
            size="92"
            compressed-size="81"
            time="2024-10-02T14:51:26+02:00"/&gt;
&lt;/c:archive&gt;</pre></div></div></div><div class="sect2" id="sect2-d354e4707"><a name="sect2-d354e4707"><!----></a><h2 class="sect2">Additional details</h2><ul class="itemizedlist"><li><p class="para">The only document-property for the document appearing on the <code class="code port">result</code> port is <code class="code property">content-type</code> (its value
      depending on the archive’s format). Note it has no <code class="code property">base-uri</code> document-property and no document-properties from the
      document on the <code class="code port">source</code> or <code class="code port">archive</code> port survive.</p></li><li><p class="para">Documents appearing on the <code class="code port">source</code> port must have a <code class="code property">base-uri</code> document-property. All these
        <code class="code property">base-uri</code> document-properties must have a unique value.</p></li><li><p class="para">A relative value for the <code class="code option">relative-to</code> option gets de-referenced against the base URI of the element in the pipeline it is
    specified on. In most cases this will be the path of the pipeline document.</p></li><li><p class="para">The only format this step is required to handle is ZIP. The ZIP format definition can be found <a href="https://pkware.cachefly.net/webdocs/casestudies/APPNOTE.TXT" target="_blank"><span class="link newpage">here</span></a>.</p></li></ul></div><div class="sect2" id="sect2-d354e4759"><a name="sect2-d354e4759"><!----></a><h2 class="sect2">Errors raised</h2><div class="table nonumber error-codes-table"><table class="table nonumber error-codes-table"><thead><tr><th><p class="para">Error code</p></th><th><p class="para">Description</p></th></tr></thead><tbody><tr><td><p class="para" id="error-XC0079"><a name="error-XC0079"><!----></a><a href="../error-codes.html#error-XC0079"><span class="link"><code class="code">XC0079</code></span></a></p></td><td><p class="para">It is a dynamic error if the map <code class="code option">parameters</code> contains an entry whose key is defined by the implementation and whose value
        is not valid for that key.</p></td></tr><tr><td><p class="para" id="error-XC0080"><a name="error-XC0080"><!----></a><a href="../error-codes.html#error-XC0080"><span class="link"><code class="code">XC0080</code></span></a></p></td><td><p class="para">It is a dynamic error if the number of documents on the <code class="code port">archive</code> does not match the expected number of archive input documents
        for the given <code class="code">format</code> and <code class="code">command</code>.</p></td></tr><tr><td><p class="para" id="error-XC0081"><a name="error-XC0081"><!----></a><a href="../error-codes.html#error-XC0081"><span class="link"><code class="code">XC0081</code></span></a></p></td><td><p class="para">It is a dynamic error if the format of the archive does not match the format as specified in the <code class="code option">format</code> option.</p></td></tr><tr><td><p class="para" id="error-XC0084"><a name="error-XC0084"><!----></a><a href="../error-codes.html#error-XC0084"><span class="link"><code class="code">XC0084</code></span></a></p></td><td><p class="para">It is a dynamic error if two or more documents appear on the <code class="code">p:archive</code> step's <code class="code port">source</code> port that have the same
        base URI or if any document that appears on the <code class="code port">source</code> port has no base URI.</p></td></tr><tr><td><p class="para" id="error-XC0085"><a name="error-XC0085"><!----></a><a href="../error-codes.html#error-XC0085"><span class="link"><code class="code">XC0085</code></span></a></p></td><td><p class="para">It is a dynamic error if the format of the archive does not match the specified format, cannot be understood, determined and/or
        processed.</p></td></tr><tr><td><p class="para" id="error-XC0100"><a name="error-XC0100"><!----></a><a href="../error-codes.html#error-XC0100"><span class="link"><code class="code">XC0100</code></span></a></p></td><td><p class="para">It is a dynamic error if the document on port <code class="code port">manifest</code> does not conform to the given schema.</p></td></tr><tr><td><p class="para" id="error-XC0112"><a name="error-XC0112"><!----></a><a href="../error-codes.html#error-XC0112"><span class="link"><code class="code">XC0112</code></span></a></p></td><td><p class="para">It is a dynamic error if more than one document appears on the port <code class="code port">manifest</code>.</p></td></tr><tr><td><p class="para" id="error-XC0118"><a name="error-XC0118"><!----></a><a href="../error-codes.html#error-XC0118"><span class="link"><code class="code">XC0118</code></span></a></p></td><td><p class="para">It is a dynamic error if an archive manifest is invalid according to the specification.</p></td></tr><tr><td><p class="para" id="error-XD0011"><a name="error-XD0011"><!----></a><a href="../error-codes.html#error-XD0011"><span class="link"><code class="code">XD0011</code></span></a></p></td><td><p class="para">It is a dynamic error if the resource referenced by the <code class="code option">href</code> option does not exist, cannot be accessed or is not a
        file.</p></td></tr><tr><td><p class="para" id="error-XD0064"><a name="error-XD0064"><!----></a><a href="../error-codes.html#error-XD0064"><span class="link"><code class="code">XD0064</code></span></a></p></td><td><p class="para">It is a dynamic error if the base URI is not both absolute and valid according to <a href="https://www.rfc-editor.org/info/rfc3986" target="_blank"><span class="link newpage">RFC&nbsp;3986</span></a> .</p></td></tr></tbody></table></div></div><div class="sect2" id="sect2-d354e4900"><a name="sect2-d354e4900"><!----></a><h2 class="sect2">Reference information</h2><p class="para">This description of the <code class="code step">p:archive</code> step is for XProc version: <a href="../index.html"><span class="link">3.0</span></a>. This is a required step (an XProc 3.0 processor must support this).</p><p class="para">The formal specification for the <code class="code step">p:archive</code> step can be found <a href="https://spec.xproc.org/3.0/steps/#c.archive" target="_blank"><span class="link newpage">here</span></a>.</p><p class="para">The <code class="code step">p:archive</code> step is part of categories:</p><ul class="itemizedlist"><li><p class="para"><a href="Standard_XProc_steps.html"><span class="link">Standard XProc steps</span></a></p></li><li><p class="para"><a href="Archive_handling.html"><span class="link">Archive handling</span></a></p></li><li><p class="para"><a href="Compression.html"><span class="link">Compression</span></a></p></li></ul><p class="para">The <code class="code step">p:archive</code> step is also present in version:
                <a href="../3.1/p.archive.html"><span class="link">3.1</span></a>.</p></div></div></div><p>&nbsp;</p></body></html>