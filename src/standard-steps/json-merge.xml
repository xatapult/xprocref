<?xml version="1.0" encoding="UTF-8"?>
<step name="json-merge"
      version-idref="v30"
      category-idrefs="standard-steps"
      short-description="[EDIT] json-merge short description"
      required="true"
      publish="false"
      href-specification="{$BASELINK-STANDARD-STEPS}#c.json-merge"
      xsi:schemaLocation="http://www.xtpxlib.nl/ns/xprocref ../../xsd/xprocref.xsd"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xmlns="http://www.xtpxlib.nl/ns/xprocref">
   <signature>
      <input port="source"
             sequence="true"
             content-types="any"
             primary="true">
         <description>
            <para>[EDIT] input source</para>
         </description>
      </input>
      <output port="result"
              content-types="application/json"
              primary="true"
              sequence="true">
         <description>
            <para>[EDIT] output result</para>
         </description>
      </output>
      <option name="duplicates"
              values="('reject', 'use-first', 'use-last', 'use-any', 'combine')"
              select="'use-first'"
              required="false"
              as="item()*">
         <description>
            <para>[EDIT] option duplicates</para>
         </description>
      </option>
      <option name="key"
              as="xs:string"
              select="'concat(&#34;_&#34;,$p:index)'"
              subtype="XPathExpression"
              required="false">
         <description>
            <para>[EDIT] option key</para>
         </description>
      </option>
   </signature>
   <summary>
      <para>[EDIT]</para>
      <para>The <tag>p:json-merge</tag> step merges the sequence of appearing on port <port>source</port> into a single JSON object appearing on port <port>result</port>. If the sequence on port <port>source</port> is empty, the empty sequence is returned on port <port>result</port>.</para>
   </summary>
   <description>
      <para>[EDIT]</para>
      <para>The step inspects the documents on port <port>source</port> in turn to create the resulting map:</para>
      <itemizedlist>
         <listitem>
            <para>If the document under inspection is a JSON document representing a map, all key-value pairs are copied into the result map unless this map already contains an entry with the given key. In this case the value of option <option>duplicates</option> determines the policy for handling duplicate keys as specified for function <code>map:merge</code> in <link xlink:href="https://www.w3.org/TR/xpath-functions-31/"
                     role="newpage"
                     xmlns:xlink="http://www.w3.org/1999/xlink">the XPath 3.1 functions</link> . <emphasis role="bold">[ERROR <step-error-ref code="XC0106"/>]</emphasis>
            </para>
         </listitem>
         <listitem>
            <para>For every other type of JSON document, for XML documents, HTML documents, or text documents a new key-value pair is created and put into the resulting map. The key is created by evaluating the XPath expression in option <option>key</option> with the inspected document as context item. If the evaluation result is a single atomic value, it is taken as key. If the evaluation result is a node, its string value is taken as key. <emphasis role="bold">[ERROR <step-error-ref code="XC0110"/>]</emphasis> Duplicate keys are handled as described above. The XDM representation of the inspected document is taken as value of the key-value pair.</para>
         </listitem>
         <listitem>
            <para>It is implementation defined if <code>p:json-merge</code> is able to process document types not mentioned yet, i.e. types of binary documents. If a processor supports a given type of documents, the key-value pair is created as described above. <emphasis role="bold">[ERROR <step-error-ref code="XC0107"/>]</emphasis>
            </para>
         </listitem>
      </itemizedlist>
      <para>An implementation must bind the variable “<code>p:index</code>” in the static context of each evaluation of the XPath expression to the position of the document in the sequence of documents on port <port>source</port>, starting with “<literal>1</literal>”. </para>
      <bridgehead>Document properties</bridgehead>
      <para feature="json-merge-preserves-none">No document properties are preserved. The merged document has no <property>base-uri</property>. </para>
   </description>
   <step-errors>
      <step-error code="XC0106">
         <description>
            <para>It is a dynamic error if duplicate keys are encountered and option <option>duplicates</option> has value “<literal>reject</literal>”.</para>
         </description>
      </step-error>
      <step-error code="XC0110">
         <description>
            <para>It is a dynamic error if the evaluation of the XPath expression in option <option>key</option> for a given item returns either a sequence, an array, a map, or a function.</para>
         </description>
      </step-error>
      <step-error code="XC0107">
         <description>
            <para> It is a dynamic error if a document of a not supported document type appears on port <port>source</port> of <code>p:json-merge</code>.</para>
         </description>
      </step-error>
   </step-errors>
</step>