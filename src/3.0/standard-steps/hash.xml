<?xml version="1.0" encoding="UTF-8"?>
<step name="hash" version-idref="v30" category-idrefs="standard-steps misc xml-base-related" short-description="Computes a hash for a value"
  required="true" publish="false" href-specification="{$BASELINK-STANDARD-STEPS-V30}#c.hash"
  xsi:schemaLocation="http://www.xtpxlib.nl/ns/xprocref ../../../xsd/xprocref.xsd" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.xtpxlib.nl/ns/xprocref">

  <!-- ======================================================================= -->

  <signature>

    <input port="source" primary="true" content-types="xml html" sequence="false">
      <description>
        <para>The source document to record the computed hash value <emphasis>in</emphasis>.</para>
      </description>
    </input>

    <output port="result" content-types="text xml html" primary="true" sequence="false">
      <description>
        <para>Result document, derived from the source document, intended to contain the hash value. See the <option>match</option> option and the
          description below.</para>
      </description>
    </output>

    <option name="parameters" as="map(xs:QName,item()*)?" required="false">
      <description>
        <para>Parameters controlling the hash value computation. Keys, values and their meaning depend on the XProc processor used.</para>
      </description>
    </option>

    <option name="value" required="true" as="xs:string">
      <description>
        <para>The string value to calculate the hash value from.</para>
      </description>
    </option>

    <option name="algorithm" required="true" as="xs:QName">
      <description>
        <para>The algorithm to use. See the description below.</para>
      </description>
    </option>

    <option name="match" as="xs:string" select="'/*/node()'" subtype="XSLTSelectionPattern" required="false">
      <description>
        <para>An XSLT selection pattern that tells <step/> where to insert the hash value in the source document. All node(s) matched are replaced
          with the computed hash value (the nodes themselves, not just their contents).</para>
        <para>If this option matches an attribute, the value of the attribute is changed.</para>
        <para>If this option matches the document node <code>/</code>, the entire document is replaced with the computed hash value. The result will
          be a text document.</para>
      </description>
    </option>

    <option name="version" as="xs:string?" required="false">
      <description>
        <para>Specifies the version of the algorithm used. If not specified, a default version is used which depends on the value of the
            <option>algorithm</option> option. See the description below. </para>
      </description>
    </option>

  </signature>

  <!-- ======================================================================= -->

  <summary>
    <para>The <step/> step generates a hash, or digital “fingerprint”, for some value and injects it into the document appearing on the
        <port>source</port> port. </para>
  </summary>

  <!-- ======================================================================= -->

  <description>
    <para>[EDIT]</para>
    <para>The value of the <option>algorithm</option> option must be a QName. If it does not have a prefix, then it must be one of the following
      values: “crc”, “md”, or “sha”.</para>
    <para>If a <tag class="attribute">version</tag> is not specified, the default version is algorithm-defined. For “<literal>crc</literal>” it is 32,
      for “<literal>md</literal>” it is 5, for “<literal>sha</literal>” it is 1.</para>
    <para>A hash is constructed from the string specified in the <option>value</option> option using the specified algorithm and version.
      Implementations must support CRC32, <link xlink:href="https://www.rfc-editor.org/info/rfc1321" role="newpage"
        xmlns:xlink="http://www.w3.org/1999/xlink">MD5</link> , and <link xlink:href="https://csrc.nist.gov/pubs/fips/180-1/final" role="newpage"
        xmlns:xlink="http://www.w3.org/1999/xlink">SHA1</link> hashes. It is implementation-defined what other algorithms are supported. The resulting
      hash should be returned as a string of hexadecimal characters. </para>
    <para>The value of the <option>match</option> option must be an XSLTSelectionPattern.</para>
    <para>The hash of the specified value is computed using the algorithm and parameters specified. <emphasis role="bold">[ERROR <step-error-ref
          code="XC0036"/>]</emphasis>
    </para>
    <para>The matched nodes are specified with the selection pattern in the <option>match</option> option. For each matching node, the string value of
      the computed hash is used in the output (if more than one node matches, the <emphasis>same</emphasis> hash value is used in each match). Nodes
      that do not match are copied without change.</para>
    <para>If the expression given in the <option>match</option> option matches an <emphasis>attribute</emphasis>, the hash is used as the new value of
      the attribute in the output. If the attribute is named “<tag class="attribute">xml:base</tag>”, the base URI of the element must also be amended
      accordingly.</para>
    <para>If the document node is matched, the entire document is replaced by a text node with the hash. What appears on port <port>result</port> is a
      text document with the text node wrapped in a document node.</para>
    <para>If the expression matches any other kind of node, the entire node (and <emphasis>not</emphasis> just its contents) is replaced by the
      hash.</para>

  </description>

  <!-- ======================================================================= -->

  <detail>
    <xi:include href="../../text-fragments/document-properties-preserved.xml"/>
    <para>The exception is when the <option>match</option> option matches the document node <code>/</code>. In that case the resulting document will
      be of type text, the <property>content-type</property> document-property will become <code>text/plain</code> and a
        <property>serialization</property> document-property is removed. Any other document-property is preserved. </para>
  </detail>

  <detail>
    <para>If the <option>match</option> option matches an attribute called <code>xml:base</code>, the base URI of this attribute&#x2019;s parent
      element is amended accordingly.</para>
  </detail>

  <!-- ======================================================================= -->

  <step-errors>
    <step-error code="XC0036"/>
  </step-errors>

</step>
